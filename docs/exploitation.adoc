= Exploitation

Ce document a pour but de décrire l'environnement applicatif ainsi que les pré-requis matériels et logiciels.

== Système de contrôle de versions

Git est utilisé comme VCS distribué.
Etant donné que le projet se limite à un POC, une seule branche est utilisée (`master`).
Le dépôt distant est sur Github à cette addresse: https://github.com/pierreboissinot/mark-manager

== Environnement

=== Back end
.Stack
* Serveur web: Nginx 1.9.5
** configuration: `heroku/nginx_host.conf`
* Framework: Symfony 4
** runtime: PHP 7.2
** configuration: `/config`
** logs: `var/log/ENV.log`
** jeu de données: `src/DataFixtures`
** gestionnaire de dépendances: composer
* Base de données: Postgresql 10

Pour plus d'informations, vous pouvez consulter la liste des dépendances dans `composer.json`

=== Front end
.Stack
* Nodejs 8.11.2
* gestionnaire de dépendances: yarn

=== Plateformes

== Déploiement vers Heroku

.Prérequis
* [Heroku CLI](https://devcenter.heroku.com/articles/heroku-cli)
* compte Heroku (free plan ok)

La procédure de déploiement vers Heroku consiste à connecter le dépôt git à une application Heroku, définir les variables d'environnement, définir les buildpacks et renseigner les variables d'environnement.

Dans la procédure qui va suivre, placez-vous à la racine du projet avant d'exécuter les commandes.

.Détails de la procédure
* `heroku create` : créee une application Heroku
* `heroku buildpacks:set heroku/php`: utilise le buidpack php officiel.
* `heroku buildpacks:set heroku/nodejs`: utilise le buildpack nodejs officiel.
* `heroku config:set APP_ENV=prod`: définit l'environnement d'exécution de Symfony
* `heroku config:set DATABASE_URL=YOUR_DATABASE_URL` : renseigne l'URL d'envoi du service mail
* `heroku config:set MAILER_URL=YOUR_MAILER_URL`
* `git push heroku master`: déploie vesr Heroku sur une nouvelle release de l'application
* `heroku open app`: ouvre l'application dans votre navigateur

Lors du build, Heroku se charge d'installer les dépendances via composer et yarn.

Après chaque déploiement, les données sont effacées et le jeu de données est utilisée.

== Déploiement continu

Cela consiste à connecter le dépôt Github à l'application Heroku.
Ainsi, tout changement sur la branche `master` déclenche le déploiement d'une nouvelle release sur Heroku.
Il suffit de suivre ce [guide](https://devcenter.heroku.com/articles/github-integration).

.Références
* https://devcenter.heroku.com/articles/getting-started-with-symfony

== Consulter les logs

`heroku logs`

=== Services

==== Amazon SES

.Prérequis
* compte AWS

.Procédure
* Créer les credentials SMTP (à renseigner dans `MAILER_URL`
* Renseigner les addresses emails des étudiants

La `MAILER_URL` sera du format:

`MAILER_URL=smtp://email-smtp.us-east-1.amazonaws.com:587?encryption=tls&username=YOUR_SES_USERNAME&password=YOUR_SES_PASSWORD`